<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SWIPE MATH</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Bubblegum+Sans&family=Finger+Paint&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #1a1028;
    --card: #2a1f3d;
    --btn-bg: #3d3456;
    --btn-border: #564d6e;
    --gold: #ffd43b;
    --text: #f1e4ff;
    --dim: #8b7baa;
    --danger: #ff4757;
    --correct: #51cf66;
  }

  body {
    font-family: 'Bubblegum Sans', cursive;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
  }

  #game-container {
    width: 100%;
    max-width: 420px;
    height: 100dvh;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ WIDGET SPACER (for play.fun rewards widget) ‚îÄ‚îÄ */
  .widget-spacer {
    height: 56px;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 20px 6px;
    z-index: 10;
  }
  .hud-score {
    font-family: 'Fredoka One', cursive;
    font-size: 28px;
    color: var(--gold);
    text-shadow: 0 2px 8px rgba(255,212,59,.4);
  }
  .hud-lives {
    display: flex; gap: 6px;
  }
  .hud-lives .heart {
    font-size: 26px;
    transition: all .3s;
    filter: drop-shadow(0 2px 4px rgba(255,71,87,.5));
  }
  .hud-lives .heart.lost {
    opacity: .2;
    transform: scale(.7);
    filter: none;
  }

  /* ‚îÄ‚îÄ TIMER BAR ‚îÄ‚îÄ */
  .timer-track {
    height: 6px;
    background: rgba(255,255,255,.08);
    margin: 4px 20px 0;
    border-radius: 3px;
    overflow: hidden;
  }
  .timer-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--correct), var(--gold), var(--danger));
    border-radius: 3px;
    width: 100%;
    transition: width linear;
  }

  /* ‚îÄ‚îÄ LEVEL BADGE ‚îÄ‚îÄ */
  .level-badge {
    text-align: center;
    padding: 8px;
    font-family: 'Finger Paint', cursive;
    font-size: 13px;
    color: var(--dim);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* ‚îÄ‚îÄ QUESTION AREA ‚îÄ‚îÄ */
  .question-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 0 20px;
  }

  .card {
    background: var(--card);
    border: 2px solid rgba(255,255,255,.06);
    border-radius: 24px;
    padding: 40px 32px;
    width: 100%;
    text-align: center;
    position: relative;
    transform-origin: center bottom;
    transition: transform .05s;
    box-shadow: 0 20px 60px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .card.swiping-left {
    border-color: var(--gold);
    box-shadow: 0 0 40px rgba(255,212,59,.12);
  }
  .card.swiping-right {
    border-color: var(--gold);
    box-shadow: 0 0 40px rgba(255,212,59,.12);
  }
  .card.fly-left { animation: flyLeft .4s ease-in forwards; }
  .card.fly-right { animation: flyRight .4s ease-in forwards; }
  .card.fly-up { animation: flyUp .35s ease-in forwards; }

  @keyframes flyLeft {
    to { transform: translateX(-140%) rotate(-25deg); opacity: 0; }
  }
  @keyframes flyRight {
    to { transform: translateX(140%) rotate(25deg); opacity: 0; }
  }
  @keyframes flyUp {
    to { transform: translateY(-120%) scale(.8); opacity: 0; }
  }
  @keyframes cardIn {
    from { transform: translateY(60px) scale(.9); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
  }
  .card.entering { animation: cardIn .3s ease-out; }

  .equation {
    font-family: 'Fredoka One', cursive;
    font-size: 48px;
    line-height: 1.2;
    color: #fff;
    text-shadow: 0 4px 16px rgba(0,0,0,.4);
    margin-bottom: 6px;
  }
  .equation-hint {
    font-size: 14px;
    color: var(--dim);
    font-family: 'Finger Paint', cursive;
  }

  /* ‚îÄ‚îÄ ANSWER PANELS (neutral) ‚îÄ‚îÄ */
  .answers {
    display: flex;
    gap: 12px;
    padding: 12px 20px 24px;
    width: 100%;
  }
  .answer-btn {
    flex: 1;
    padding: 20px 8px;
    border: 2px solid var(--btn-border);
    border-radius: 18px;
    font-family: 'Fredoka One', cursive;
    font-size: 32px;
    cursor: pointer;
    transition: transform .15s, box-shadow .15s, background .15s;
    position: relative;
    overflow: hidden;
    background: var(--btn-bg);
    color: var(--text);
    box-shadow: 0 6px 24px rgba(0,0,0,.3);
    -webkit-tap-highlight-color: transparent;
  }
  .answer-btn:active {
    transform: scale(.95);
    background: #4a4065;
  }
  .answer-label {
    font-family: 'Finger Paint', cursive;
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    opacity: .5;
    display: block;
    margin-bottom: 4px;
  }

  /* ‚îÄ‚îÄ SWIPE INDICATORS ‚îÄ‚îÄ */
  .swipe-indicator {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 48px;
    opacity: 0;
    transition: opacity .15s;
    pointer-events: none;
    z-index: 20;
  }
  .swipe-indicator.left { left: 24px; }
  .swipe-indicator.right { right: 24px; }

  /* ‚îÄ‚îÄ RESULT FLASH ‚îÄ‚îÄ */
  .flash-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 50;
    opacity: 0;
    transition: opacity .15s;
  }
  .flash-overlay.correct {
    background: radial-gradient(circle, rgba(81,207,102,.25), transparent 70%);
    opacity: 1;
  }
  .flash-overlay.wrong {
    background: radial-gradient(circle, rgba(255,71,87,.3), transparent 70%);
    opacity: 1;
    animation: shake .4s;
  }
  @keyframes shake {
    10%, 90% { transform: translateX(-2px); }
    20%, 80% { transform: translateX(4px); }
    30%, 50%, 70% { transform: translateX(-6px); }
    40%, 60% { transform: translateX(6px); }
  }

  /* ‚îÄ‚îÄ COMBO ‚îÄ‚îÄ */
  .combo-text {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Fredoka One', cursive;
    font-size: 36px;
    color: var(--gold);
    text-shadow: 0 0 20px rgba(255,212,59,.6);
    pointer-events: none;
    z-index: 60;
    opacity: 0;
  }
  .combo-text.show {
    animation: comboPop .7s ease-out forwards;
  }
  @keyframes comboPop {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(.5); }
    30% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
    100% { opacity: 0; transform: translate(-50%, -70%) scale(1); }
  }

  /* ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ */
  .particle {
    position: absolute;
    width: 8px; height: 8px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 55;
  }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  .screen-overlay {
    position: absolute;
    inset: 0;
    background: rgba(26,16,40,.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 40px;
    text-align: center;
    opacity: 1;
    transition: opacity .4s;
  }
  .screen-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }
  .screen-title {
    font-family: 'Fredoka One', cursive;
    font-size: 52px;
    line-height: 1.1;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--gold), #ff922b, #ff6b6b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 4px 12px rgba(255,146,43,.3));
  }
  .screen-subtitle {
    font-family: 'Finger Paint', cursive;
    font-size: 16px;
    color: var(--dim);
    margin-bottom: 36px;
    line-height: 1.5;
  }
  .screen-stats { margin-bottom: 28px; }
  .stat-line {
    font-family: 'Bubblegum Sans', cursive;
    font-size: 22px;
    color: var(--text);
    margin: 8px 0;
  }
  .stat-line span {
    color: var(--gold);
    font-family: 'Fredoka One', cursive;
  }
  .play-btn {
    font-family: 'Fredoka One', cursive;
    font-size: 24px;
    padding: 18px 48px;
    border: none;
    border-radius: 50px;
    background: linear-gradient(135deg, var(--gold), #ff922b);
    color: var(--bg);
    cursor: pointer;
    box-shadow: 0 8px 30px rgba(255,212,59,.35);
    transition: transform .2s, box-shadow .2s;
    letter-spacing: 1px;
    -webkit-tap-highlight-color: transparent;
  }
  .play-btn:hover { transform: scale(1.05); box-shadow: 0 12px 40px rgba(255,212,59,.5); }
  .play-btn:active { transform: scale(.97); }

  .swipe-tutorial {
    margin-top: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    font-family: 'Finger Paint', cursive;
    font-size: 13px;
    color: var(--dim);
  }
  .swipe-tutorial .arrow {
    font-size: 28px;
    animation: sway 1.5s ease-in-out infinite alternate;
  }
  @keyframes sway { from { transform: translateX(-6px); } to { transform: translateX(6px); } }

  /* ‚îÄ‚îÄ MUTE BUTTON ‚îÄ‚îÄ */
  .mute-btn {
    position: absolute;
    bottom: 24px;
    right: 16px;
    z-index: 110;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 50%;
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 18px;
    -webkit-tap-highlight-color: transparent;
    transition: background .2s;
  }
  .mute-btn:hover { background: rgba(255,255,255,.15); }

  /* floating bg shapes */
  .bg-shape {
    position: absolute;
    border-radius: 50%;
    opacity: .04;
    pointer-events: none;
    z-index: 0;
  }
  .bg-shape:nth-child(1) { width:200px;height:200px;background:#ff6b6b;top:-40px;left:-60px; }
  .bg-shape:nth-child(2) { width:300px;height:300px;background:var(--gold);bottom:-80px;right:-100px; }
  .bg-shape:nth-child(3) { width:150px;height:150px;background:var(--correct);top:40%;left:-50px; }

  @media (max-height: 640px) {
    .widget-spacer { height: 44px; }
    .equation { font-size: 36px; }
    .card { padding: 28px 24px; }
    .answer-btn { padding: 14px 8px; font-size: 26px; }
  }
</style>
</head>
<body>
<div id="game-container">
  <div class="bg-shape"></div>
  <div class="bg-shape"></div>
  <div class="bg-shape"></div>

  <!-- Spacer for play.fun rewards widget -->
  <div class="widget-spacer"></div>

  <!-- Mute toggle -->
  <button class="mute-btn" id="mute-btn">üîä</button>

  <!-- HUD -->
  <div class="hud">
    <div class="hud-score" id="score">0</div>
    <div class="hud-lives" id="lives">
      <span class="heart" id="h1">‚ù§Ô∏è</span>
      <span class="heart" id="h2">‚ù§Ô∏è</span>
    </div>
  </div>
  <div class="timer-track"><div class="timer-fill" id="timer"></div></div>
  <div class="level-badge" id="level-badge">Level 1 ‚Äî Easy Peasy</div>

  <!-- QUESTION -->
  <div class="question-area" id="question-area">
    <div class="flash-overlay" id="flash"></div>
    <div class="combo-text" id="combo"></div>
    <div class="swipe-indicator left" id="ind-left">üëà</div>
    <div class="swipe-indicator right" id="ind-right">üëâ</div>

    <div class="card" id="card">
      <div class="equation" id="equation">2 + 3</div>
      <div class="equation-hint">swipe or tap!</div>
    </div>
  </div>

  <!-- ANSWERS (neutral colour) -->
  <div class="answers">
    <button class="answer-btn" id="btn-left" ontouchstart="">
      <span class="answer-label">‚óÄ swipe</span>
      <span id="ans-left">5</span>
    </button>
    <button class="answer-btn" id="btn-right" ontouchstart="">
      <span class="answer-label">swipe ‚ñ∂</span>
      <span id="ans-right">7</span>
    </button>
  </div>

  <!-- START SCREEN -->
  <div class="screen-overlay" id="start-screen">
    <div class="screen-title">SWIPE<br>MATH</div>
    <div class="screen-subtitle">
      Swipe left or right to pick the answer.<br>
      Be fast! ‚è±Ô∏è You only get 5 seconds.<br>
      2 mistakes and you're out!
    </div>
    <button class="play-btn" id="start-btn">LET'S GO!</button>
    <div class="swipe-tutorial">
      <span class="arrow">üëà</span>
      swipe or tap
      <span class="arrow">üëâ</span>
    </div>
  </div>

  <!-- GAME OVER -->
  <div class="screen-overlay hidden" id="gameover-screen">
    <div class="screen-title">GAME<br>OVER</div>
    <div class="screen-stats">
      <div class="stat-line">Score: <span id="final-score">0</span></div>
      <div class="stat-line">Best streak: <span id="final-streak">0</span></div>
      <div class="stat-line">Level reached: <span id="final-level">1</span></div>
    </div>
    <button class="play-btn" id="retry-btn">TRY AGAIN</button>
  </div>
</div>

<script>
(() => {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  AUDIO ENGINE (Web Audio API)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let audioCtx, masterGain, bgmGain;
  let muted = false;
  let bgmInterval = null;
  let bgmBPM = 140;

  function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.5;
    masterGain.connect(audioCtx.destination);
    bgmGain = audioCtx.createGain();
    bgmGain.gain.value = 0.18;
    bgmGain.connect(masterGain);
  }

  function setMuted(m) {
    muted = m;
    if (masterGain) masterGain.gain.value = muted ? 0 : 0.5;
    document.getElementById('mute-btn').textContent = muted ? 'üîá' : 'üîä';
  }

  // ‚îÄ‚îÄ SFX ‚îÄ‚îÄ
  function playNote(freq, duration, type = 'square', gainVal = 0.3, dest) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(gainVal, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(g);
    g.connect(dest || masterGain);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  function sfxCorrect() {
    playNote(523, 0.1, 'square', 0.25);
    setTimeout(() => playNote(659, 0.1, 'square', 0.25), 60);
    setTimeout(() => playNote(784, 0.15, 'square', 0.2), 120);
  }

  function sfxWrong() {
    playNote(200, 0.15, 'sawtooth', 0.3);
    setTimeout(() => playNote(160, 0.25, 'sawtooth', 0.25), 100);
  }

  function sfxCombo() {
    const notes = [523, 659, 784, 1047];
    notes.forEach((n, i) => setTimeout(() => playNote(n, 0.12, 'square', 0.2), i * 70));
  }

  function sfxTick() {
    playNote(880, 0.04, 'sine', 0.1);
  }

  function sfxTimeout() {
    playNote(300, 0.3, 'triangle', 0.2);
  }

  function sfxGameOver() {
    const notes = [400, 350, 300, 200];
    notes.forEach((n, i) => setTimeout(() => playNote(n, 0.3, 'sawtooth', 0.2), i * 150));
  }

  // ‚îÄ‚îÄ BGM (procedural upbeat loop) ‚îÄ‚îÄ
  const bgmMelody = [
    392, 440, 523, 440, 392, 523, 587, 523,
    440, 523, 587, 659, 587, 523, 440, 392,
    523, 587, 659, 784, 659, 587, 523, 587,
    440, 392, 440, 523, 440, 392, 349, 392,
  ];
  let bgmStep = 0;

  const bgmBass = [196, 196, 220, 220, 262, 262, 220, 220];
  let bassStep = 0;

  function startBGM(bpm) {
    stopBGM();
    if (!audioCtx) return;
    bgmBPM = bpm;
    bgmStep = 0;
    bassStep = 0;

    const interval = (60 / bgmBPM) * 1000 / 2;

    bgmInterval = setInterval(() => {
      const freq = bgmMelody[bgmStep % bgmMelody.length];
      playNote(freq, 0.08, 'square', 0.06, bgmGain);

      if (bgmStep % 4 === 0) {
        const bFreq = bgmBass[bassStep % bgmBass.length];
        playNote(bFreq, 0.15, 'triangle', 0.1, bgmGain);
        bassStep++;
      }

      if (bgmStep % 2 === 0) playKick();
      if (bgmStep % 2 === 1) playHiHat();

      bgmStep++;
    }, interval);
  }

  function playKick() {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.1);
    g.gain.setValueAtTime(0.15, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.12);
    osc.connect(g);
    g.connect(bgmGain);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.12);
  }

  function playHiHat() {
    if (!audioCtx) return;
    const bufferSize = audioCtx.sampleRate * 0.03;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    const hp = audioCtx.createBiquadFilter();
    hp.type = 'highpass';
    hp.frequency.value = 8000;
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.04, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
    src.connect(hp);
    hp.connect(g);
    g.connect(bgmGain);
    src.start();
  }

  function setBGMSpeed(bpm) {
    if (bgmInterval) startBGM(bpm);
  }

  function stopBGM() {
    if (bgmInterval) { clearInterval(bgmInterval); bgmInterval = null; }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  GAME STATE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let score = 0, lives = 2, streak = 0, bestStreak = 0, level = 1;
  let correctAnswer, correctSide, playing = false;
  let timerInterval, timeLeft, roundDuration = 5000;
  let swipeStartX = 0, swipeStartY = 0, isDragging = false, cardDx = 0;
  let answered = false;

  const $ = id => document.getElementById(id);
  const scoreEl = $('score'), timerEl = $('timer'), levelEl = $('level-badge');
  const card = $('card'), eqEl = $('equation');
  const ansL = $('ans-left'), ansR = $('ans-right');
  const btnL = $('btn-left'), btnR = $('btn-right');
  const flash = $('flash'), comboEl = $('combo');
  const indL = $('ind-left'), indR = $('ind-right');
  const h1 = $('h1'), h2 = $('h2');
  const startScreen = $('start-screen'), overScreen = $('gameover-screen');

  const levelNames = [
    'Easy Peasy', 'Getting Warmer', 'Not Bad!', 'Heating Up',
    'Big Brain Time', 'Math Wizard', 'Galaxy Brain', 'LEGENDARY'
  ];

  function bpmForLevel(lv) {
    return Math.min(120 + (lv - 1) * 18, 260);
  }

  function genQuestion() {
    let a, b, op, answer, display;
    const diff = Math.min(level, 8);

    if (diff <= 2) {
      a = randInt(1, 10 + diff * 5);
      b = randInt(1, 10 + diff * 5);
      if (Math.random() < .5) { op = '+'; answer = a + b; }
      else { if (a < b) [a,b] = [b,a]; op = '‚àí'; answer = a - b; }
      display = `${a} ${op} ${b}`;
    } else if (diff <= 4) {
      const r = Math.random();
      if (r < .4) {
        a = randInt(2, 12); b = randInt(2, 12);
        answer = a * b; display = `${a} √ó ${b}`;
      } else if (r < .7) {
        a = randInt(10, 50 + diff*10); b = randInt(5, 30 + diff*5);
        answer = a + b; display = `${a} + ${b}`;
      } else {
        a = randInt(20, 80); b = randInt(5, a);
        answer = a - b; display = `${a} ‚àí ${b}`;
      }
    } else if (diff <= 6) {
      const r = Math.random();
      if (r < .3) {
        b = randInt(2, 12); answer = randInt(2, 12); a = b * answer;
        display = `${a} √∑ ${b}`;
      } else if (r < .5) {
        a = randInt(2, 15); answer = a * a;
        display = `${a}¬≤`;
      } else if (r < .75) {
        a = randInt(5, 20); b = randInt(5, 20);
        answer = a * b; display = `${a} √ó ${b}`;
      } else {
        a = randInt(50, 200); b = randInt(20, 100);
        if (a < b) [a,b] = [b,a];
        answer = a - b; display = `${a} ‚àí ${b}`;
      }
    } else {
      const r = Math.random();
      if (r < .2) {
        a = randInt(2, 8); answer = a * a * a;
        display = `${a}¬≥`;
      } else if (r < .4) {
        const pct = [10,20,25,50][randInt(0,3)];
        a = randInt(2, 20) * (100/pct);
        answer = a * pct / 100;
        display = `${pct}% of ${a}`;
      } else if (r < .6) {
        a = randInt(10, 30); b = randInt(10, 30);
        answer = a * b; display = `${a} √ó ${b}`;
      } else if (r < .8) {
        a = randInt(100, 500); b = randInt(50, 300);
        if (a < b) [a,b] = [b,a];
        answer = a - b; display = `${a} ‚àí ${b}`;
      } else {
        b = randInt(3, 15); answer = randInt(3, 25); a = b * answer;
        display = `${a} √∑ ${b}`;
      }
    }
    return { display, answer };
  }

  function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

  function genWrongAnswer(correct) {
    const offsets = [1,2,3,5,10,-1,-2,-3,-5,-10];
    let wrong;
    do { wrong = correct + offsets[randInt(0, offsets.length-1)]; } while (wrong === correct);
    return wrong;
  }

  // ‚îÄ‚îÄ ROUND ‚îÄ‚îÄ
  function nextRound() {
    answered = false;
    const q = genQuestion();
    correctAnswer = q.answer;
    const wrong = genWrongAnswer(correctAnswer);

    if (Math.random() < .5) {
      ansL.textContent = correctAnswer;
      ansR.textContent = wrong;
      correctSide = 'left';
    } else {
      ansR.textContent = correctAnswer;
      ansL.textContent = wrong;
      correctSide = 'right';
    }

    eqEl.textContent = q.display;
    const newLevel = Math.floor(score / 3) + 1;
    if (newLevel !== level) {
      level = newLevel;
      setBGMSpeed(bpmForLevel(level));
    }
    level = newLevel;
    const lvlIdx = Math.min(level - 1, levelNames.length - 1);
    levelEl.textContent = `Level ${level} ‚Äî ${levelNames[lvlIdx]}`;

    card.className = 'card entering';
    card.style.transform = '';

    // Reset timer fully each turn
    timerEl.style.transition = 'none';
    timerEl.style.width = '100%';
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        timerEl.style.transition = `width ${roundDuration}ms linear`;
        timerEl.style.width = '0%';
      });
    });

    clearInterval(timerInterval);
    const start = Date.now();
    let lastTick = -1;
    timerInterval = setInterval(() => {
      const elapsed = Date.now() - start;
      const remaining = roundDuration - elapsed;
      // Tick every 500ms in last 2 seconds
      if (remaining <= 2000 && remaining > 0) {
        const tickNum = Math.floor((2000 - remaining) / 500);
        if (tickNum > lastTick) { lastTick = tickNum; sfxTick(); }
      }
      if (elapsed >= roundDuration) {
        clearInterval(timerInterval);
        sfxTimeout();
        handleAnswer(null);
      }
    }, 50);
  }

  function handleAnswer(side) {
    if (!playing || answered) return;
    answered = true;
    clearInterval(timerInterval);

    const isCorrect = side === correctSide;

    if (isCorrect) {
      score++;
      streak++;
      if (streak > bestStreak) bestStreak = streak;
      scoreEl.textContent = score;
      flashEffect('correct');
      sfxCorrect();
      card.className = 'card ' + (side === 'left' ? 'fly-left' : 'fly-right');

      if (streak >= 3 && streak % 3 === 0) { showCombo(streak); sfxCombo(); }
      spawnParticles(side === 'left' ? 80 : window.innerWidth - 80, window.innerHeight * .4, 'var(--correct)');

      setTimeout(nextRound, 400);
    } else {
      lives--;
      streak = 0;
      updateHearts();
      flashEffect('wrong');
      sfxWrong();

      if (side) {
        card.className = 'card ' + (side === 'left' ? 'fly-left' : 'fly-right');
      } else {
        card.className = 'card fly-up';
      }

      if (lives <= 0) {
        setTimeout(gameOver, 500);
      } else {
        setTimeout(nextRound, 500);
      }
    }
  }

  function flashEffect(type) {
    flash.className = 'flash-overlay ' + type;
    setTimeout(() => flash.className = 'flash-overlay', 400);
  }

  function showCombo(n) {
    comboEl.textContent = `üî• ${n} STREAK!`;
    comboEl.className = 'combo-text show';
    setTimeout(() => comboEl.className = 'combo-text', 700);
  }

  function spawnParticles(x, y, color) {
    const area = $('question-area');
    for (let i = 0; i < 8; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      p.style.background = color;
      const angle = (Math.PI * 2 / 8) * i + Math.random() * .5;
      const dist = 60 + Math.random() * 80;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;
      p.style.transition = 'all .5s ease-out';
      area.appendChild(p);
      requestAnimationFrame(() => {
        p.style.transform = `translate(${dx}px, ${dy}px) scale(0)`;
        p.style.opacity = '0';
      });
      setTimeout(() => p.remove(), 600);
    }
  }

  function updateHearts() {
    h1.className = lives >= 1 ? 'heart' : 'heart lost';
    h2.className = lives >= 2 ? 'heart' : 'heart lost';
  }

  // ‚îÄ‚îÄ SWIPE HANDLING ‚îÄ‚îÄ
  const qa = $('question-area');

  qa.addEventListener('pointerdown', e => {
    if (!playing) return;
    e.preventDefault();
    qa.setPointerCapture(e.pointerId);
    isDragging = true;
    swipeStartX = e.clientX;
    swipeStartY = e.clientY;
    cardDx = 0;
    card.style.transition = 'none';
  });

  qa.addEventListener('pointermove', e => {
    if (!isDragging || !playing) return;
    e.preventDefault();
    cardDx = e.clientX - swipeStartX;
    const rotate = cardDx * 0.08;
    card.style.transform = `translateX(${cardDx}px) rotate(${rotate}deg)`;

    if (cardDx < -40) {
      card.classList.add('swiping-left');
      card.classList.remove('swiping-right');
      indL.style.opacity = Math.min(1, (Math.abs(cardDx) - 40) / 60);
      indR.style.opacity = 0;
    } else if (cardDx > 40) {
      card.classList.add('swiping-right');
      card.classList.remove('swiping-left');
      indR.style.opacity = Math.min(1, (cardDx - 40) / 60);
      indL.style.opacity = 0;
    } else {
      card.classList.remove('swiping-left', 'swiping-right');
      indL.style.opacity = 0;
      indR.style.opacity = 0;
    }
  });

  qa.addEventListener('pointerup', e => {
    if (!isDragging || !playing) return;
    e.preventDefault();
    isDragging = false;
    indL.style.opacity = 0;
    indR.style.opacity = 0;

    const threshold = 50;
    if (cardDx < -threshold) {
      handleAnswer('left');
    } else if (cardDx > threshold) {
      handleAnswer('right');
    } else {
      card.style.transition = 'transform .2s';
      card.style.transform = '';
      card.classList.remove('swiping-left', 'swiping-right');
    }
  });

  qa.addEventListener('pointercancel', () => {
    isDragging = false;
    card.style.transition = 'transform .2s';
    card.style.transform = '';
    indL.style.opacity = 0;
    indR.style.opacity = 0;
  });

  document.addEventListener('touchmove', e => { if (playing) e.preventDefault(); }, { passive: false });

  // Button taps
  btnL.addEventListener('click', () => { if (playing) handleAnswer('left'); });
  btnR.addEventListener('click', () => { if (playing) handleAnswer('right'); });

  // ‚îÄ‚îÄ START / GAME OVER ‚îÄ‚îÄ
  function startGame() {
    initAudio();
    score = 0; lives = 2; streak = 0; bestStreak = 0; level = 1;
    scoreEl.textContent = 0;
    updateHearts();
    startScreen.classList.add('hidden');
    overScreen.classList.add('hidden');
    playing = true;
    startBGM(bpmForLevel(1));
    nextRound();
  }

  function gameOver() {
    playing = false;
    clearInterval(timerInterval);
    stopBGM();
    sfxGameOver();
    $('final-score').textContent = score;
    $('final-streak').textContent = bestStreak;
    $('final-level').textContent = level;
    overScreen.classList.remove('hidden');
  }

  $('start-btn').addEventListener('click', startGame);
  $('retry-btn').addEventListener('click', startGame);
  $('mute-btn').addEventListener('click', () => setMuted(!muted));

  // Keyboard support
  document.addEventListener('keydown', e => {
    if (!playing) {
      if (e.key === 'Enter' || e.key === ' ') startGame();
      return;
    }
    if (e.key === 'ArrowLeft' || e.key === 'a') handleAnswer('left');
    if (e.key === 'ArrowRight' || e.key === 'd') handleAnswer('right');
    if (e.key === 'm') setMuted(!muted);
  });
})();
</script>
</body>
</html>
